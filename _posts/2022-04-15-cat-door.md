---
title: Cat Door Sensor
author: jon
layout: post
categories:
  - IoT
  - Hardware
  - WLED
image: 2022/cat_door/cat_thumb.webp
---

I added a cat door to one of our windows to give our cat a bit more freedom to make up from our lack of attention due to the baby. Since I sometimes want the window closed, I wanted an easy way to check if she was in or outside.

[<img class="center" src="{{ site.image_host }}/2022/cat_door/cat_thumb.webp" alt="agent link">]({{ site.image_host }}/2022/cat_door/cat.jpg)

# Hardware

Ideally, I could do remote sensing. For that, I considered a vision system or a sonar range finder. After thinking them through though, I decided a range finder wouldn't work and a camera was way too much overkill. Instead, I decided to go with hall effect magnetic sensors.

Next I needed a way to differentiate when the door opened and closed. I could use multiple sensors, or multiple magnets in opposite orientations. Since I wanted the sensor(s) to be on the portion of the window that wasn't moving, I decided to go with two sensors, and one magnet on the swinging part of the door.

In an effort to do this as fast as possible, I picked the first sensor I saw that could work with the 3.3V supply from an ESP8266 the [49E Linear Hall-Effect Sensor](https://www.diodes.com/assets/Datasheets/AH49E.pdf).

I was hoping the one of the voltage swings would be able to trigger a digital input transition. Unfortunately, the voltage without a magnetic field is at half the supply voltage which meant that I couldn't easily trigger a digital input change. Instead I would need to use the analog-to-digital converter (ADC).

I'm using a [D1 Mini Lite](https://www.wemos.cc/en/latest/d1/d1_mini_lite.html) which has a single ADC with a voltage divider. I needed a way to read the output of two sensors with a single input. To solve this, I used the following circuit:

[<img class="center" src="{{ site.image_host }}/2022/cat_door/sensor_thumb.webp" alt="agent link">]({{ site.image_host }}/2022/cat_door/sensor.jpg)

The output of the two sensors are connected to each other through a voltage divider. They are triggered with the positive side of a single magnet. This results in the following outputs:

1. Neither sensor triggered by a magnet - Both output 1.8V so the output is 1.8V
2. The 10K olm sensor is triggered - 10K outputs 2.7V the 20K outputs 1.8V. There's a 0.9V drop with the voltage divider dropping 1/3 for an output voltage of 2.4V.
3. The 20K olm sensor is triggered - 20K outputs 2.7V the 10K outputs 1.8V. There's a 0.9V drop with the voltage divider dropping 2/3 for an output voltage of 2V.

This would hopefully give a big enough voltage swing to consistently differentiate these 3 states.

I then put this together in an extremely hacky manner.

[<img class="center" src="{{ site.image_host }}/2022/cat_door/closeup_thumb.webp" alt="agent link">]({{ site.image_host }}/2022/cat_door/closeup.jpg)

[<img class="center" src="{{ site.image_host }}/2022/cat_door/door_thumb.webp" alt="agent link">]({{ site.image_host }}/2022/cat_door/door.jpg)

# Software

[GitHub Repo](https://github.com/axlan/cat-door)

The first thing I needed to decide was what to do when I detect that our cat went in our out. Since one of my previous LED projects ([Fire Emblem Lights]({% post_url 2020-01-14-fire-emblem-lights %})) is right next to the window I decided to have a portion of it turn on or off to show if the cat is in our out. This was trivial to accomplish with a simple HTTP POST to the [WLED's JSON API](https://kno.wled.ge/interfaces/json-api/). There can be a fairly long delay between going through the door and the light change, but that's fine for this application.

With this settled I made a basic state machine to trigger the lion to light up when the door was flapped inward and turn off when the door flapped outward. This sort of worked but hit a few problems:

1. Since I was sampling the ADC in a loop, it was possible to miss sensor triggers. This was especially true since the loop blocked for seconds to send the POST requests.
2. The door would flap back and forth which could cause an unwanted trigger.
3. Sometime the door would stick slightly opened causing continuous triggering.

The first issue I looked into fixing by sampling on interrupts instead of in the main processing loop. I realized that there wasn't an easy way to sample on either ADC value changes or on ADC completion. I could have sampled on a timer, but in the end it seemed like this wasn't that big of an issue because of my next fix.

For the second issue, I fixed by only counting the first sensor trigger, then ignoring further triggers for the next 10 seconds. This works in most cases, though could have issues when the cat waits for over ten seconds half way through the flap. That case would be pretty hard to handle without additional sensors though.

The 3rd issue here would be best fix by cleaning the door up, but I added some additional logic to the state machine to ignore a value if it seems like the door is stuck. This was probably the hackiest part of the code.

With these hacks in place I got a fairly accurate indication of cat status:

<video controls loop width="384">
  <source src="{{ site.image_host }}/2022/cat_door/cat_out.m4v" type="video/mp4" />
</video>

<video controls loop width="384">
  <source src="{{ site.image_host }}/2022/cat_door/cat_in.m4v" type="video/mp4" />
</video>
